<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Registrar Estudante</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    video, canvas {
      max-width: 100%;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
  </style>
</head>
<body class="bg-light">

<div class="container mt-5">
  <h2>Registrar Novo Estudante</h2>
  <form method="POST" enctype="multipart/form-data" id="formRegistro">

    <!-- Abas -->
    <ul class="nav nav-tabs" id="formTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-pessoal" data-bs-toggle="tab" data-bs-target="#dadosPessoais" type="button" role="tab">Dados Pessoais</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-academico" data-bs-toggle="tab" data-bs-target="#dadosAcademicos" type="button" role="tab">Dados AcadÃªmicos</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-foto" data-bs-toggle="tab" data-bs-target="#fotoEstudante" type="button" role="tab">Foto do Estudante</button>
      </li>
    </ul>

    <div class="tab-content border border-top-0 p-3">
      <!-- Aba Dados Pessoais -->
      <div class="tab-pane fade show active" id="dadosPessoais" role="tabpanel">
        <div class="mb-3">
          <label class="form-label">Nome completo:</label>
          <input type="text" class="form-control" name="nome" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Data de Nascimento:</label>
          <div class="d-flex gap-2">
            <select name="dia_nascimento" class="form-select" required>
              {% for d in range(1, 32) %}<option value="{{ d }}">{{ d }}</option>{% endfor %}
            </select>
            <select name="mes_nascimento" class="form-select" required>
              {% for m in range(1, 13) %}<option value="{{ m }}">{{ m }}</option>{% endfor %}
            </select>
            <select name="ano_nascimento" class="form-select" required>
              {% for y in range(1980, 2025) %}<option value="{{ y }}">{{ y }}</option>{% endfor %}
            </select>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">NÃºmero do BI:</label>
          <input type="text" class="form-control" name="numero_bi" required>
        </div>
      </div>

      <!-- Aba Dados AcadÃªmicos -->
      <div class="tab-pane fade" id="dadosAcademicos" role="tabpanel">
        <div class="mb-3">
          <label class="form-label">Curso:</label>
          <select class="form-select" name="curso" required>
            <option value="InformÃ¡tica">InformÃ¡tica</option>
            <option value="Enfermagem">Enfermagem</option>
            <option value="Contabilidade">Contabilidade</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">PerÃ­odo:</label>
          <select class="form-select" name="periodo" required>
            <option value="Regular">Regular</option>
            <option value="PÃ³s-Laboral">PÃ³s-Laboral</option>
          </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Ano de FrequÃªncia:</label>
          <select class="form-select" name="ano_frequencia" required>
            <option value="1Âº Ano">1Âº Ano</option>
            <option value="2Âº Ano">2Âº Ano</option>
            <option value="3Âº Ano">3Âº Ano</option>
            <option value="4Âº Ano">4Âº Ano</option>
            <option value="5Âº Ano">5Âº Ano</option>
          </select>
        </div>
      </div>

      <!-- Aba Foto -->
      <div class="tab-pane fade" id="fotoEstudante" role="tabpanel">
        <div class="mb-3">
          <label class="form-label">Selecionar mÃ©todo de envio de foto:</label>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="metodo_foto" value="upload" id="radioUpload" checked onclick="alternarMetodoFoto()">
            <label class="form-check-label" for="radioUpload">Upload Manual</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="metodo_foto" value="camera" id="radioCamera" onclick="alternarMetodoFoto()">
            <label class="form-check-label" for="radioCamera">Capturar com CÃ¢mera</label>
          </div>
        </div>

        <div class="mb-3" id="fotoUpload">
          <label class="form-label">Foto do rosto (Upload):</label>
          <input type="file" class="form-control" name="foto_manual" accept="image/*">
        </div>

        <div class="mb-3 d-none" id="fotoCamera">
          <label class="form-label">Capturar foto com a cÃ¢mera:</label><br>
          <video id="webcam" autoplay></video>
          <canvas id="captura" style="display:none;"></canvas>
          <input type="hidden" name="imagem_capturada" id="imagem_capturada">
          <button type="button" class="btn btn-outline-primary mt-2" onclick="capturarFoto()">ðŸ“· Capturar</button>
        </div>
      </div>
    </div>

    <!-- BotÃµes -->
    <div class="mt-4">
      <button type="submit" class="btn btn-success">Registrar Estudante</button>
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Cancelar</a>
    </div>
  </form>
</div>

<script>
  const video = document.getElementById('webcam');
  const canvas = document.getElementById('captura');
  const inputCaptura = document.getElementById('imagem_capturada');

  function alternarMetodoFoto() {
    const metodo = document.querySelector('input[name="metodo_foto"]:checked').value;
    document.getElementById('fotoUpload').classList.toggle('d-none', metodo !== 'upload');
    document.getElementById('fotoCamera').classList.toggle('d-none', metodo !== 'camera');
  }

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => { video.srcObject = stream; })
    .catch(err => { console.error("Erro ao acessar webcam", err); });

  function capturarFoto() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    const imagem = canvas.toDataURL('image/jpeg');
    inputCaptura.value = imagem;
    alert("âœ… Foto capturada com sucesso!");
  }
  // ValidaÃ§Ã£o personalizada
  document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('formRegistro');
  if (!form) return;

  form.addEventListener('submit', (e) => {
    let valido = true;
    form.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
    form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

    const mostrarErro = (input, mensagem) => {
      input.classList.add('is-invalid');
      const feedback = document.createElement('div');
      feedback.className = 'invalid-feedback';
      feedback.innerText = mensagem;
      input.parentNode.appendChild(feedback);
      valido = false;
    };

    const validarNome = campo => {
      const valor = campo.value.trim();
      if (!valor) {
        mostrarErro(campo, 'Campo obrigatÃ³rio.');
      } else if (!/^[A-ZÃÃ‰ÃÃ“ÃšÃ‚ÃŠÃ”ÃƒÃ•Ã‡][a-zÃ¡Ã©Ã­Ã³ÃºÃ¢ÃªÃ´Ã£ÃµÃ§]+(?:\s[A-ZÃÃ‰ÃÃ“ÃšÃ‚ÃŠÃ”ÃƒÃ•Ã‡][a-zÃ¡Ã©Ã­Ã³ÃºÃ¢ÃªÃ´Ã£ÃµÃ§]+)+$/.test(valor)) {
        mostrarErro(campo, 'Informe pelo menos dois nomes, iniciando com letras maiÃºsculas.');
      }
    };

    const validarBI = campo => {
      const valor = campo.value.trim();
      if (!valor) {
        mostrarErro(campo, 'NÃºmero do BI Ã© obrigatÃ³rio.');
      } else if (!/^\d{9}[A-Z]{2}\d{3}$/i.test(valor)) {
        mostrarErro(campo, 'Formato invÃ¡lido. Exemplo correto: 123456789LA012');
      }
    };

    validarNome(form.querySelector('[name="nome"]'));
    validarBI(form.querySelector('[name="numero_bi"]'));

    ['curso', 'periodo', 'ano_frequencia'].forEach(nomeCampo => {
      const campo = form.querySelector(`[name="${nomeCampo}"]`);
      if (campo && !campo.value) {
        mostrarErro(campo, 'Campo obrigatÃ³rio.');
      }
    });

    if (!valido) e.preventDefault();
  });
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
